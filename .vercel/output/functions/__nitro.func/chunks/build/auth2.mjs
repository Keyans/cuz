import{o as e,O as t}from"./server.mjs";import a from"axios";import o from"lodash/debounce.js";let r=new Map;const getPendingUrl=e=>[e.method,e.url].join("&");const s=[100100,100101,100102,100103,100104,9],n=[2,3,5,6],i=new class{addPending(e){this.removePending(e);const t=getPendingUrl(e);e.cancelToken=e.cancelToken||new a.CancelToken((e=>{r.has(t)||r.set(t,e)}))}removePending(e){const t=getPendingUrl(e);if(r.has(t)){const e=r.get(t);null==e||e(t),r.delete(t)}}removeAllPending(){r.forEach((e=>{"function"==typeof e&&e()})),r.clear()}reset(){r=new Map}};let l=!0;const d="Bearer ";a.defaults.headers.post["Content-Type"]="application/json",a.defaults.headers.put["Content-Type"]="application/json";const u=a.create({baseURL:"/",timeout:1e4,withCredentials:!1,headers:{"Client-Hardware-Id":1,"Client-Type":"SHOP_CONSOLE","Platform-Ids":0,Timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,Appenv:"PC"}});let c=!1,h=[];u.interceptors.request.use((e=>{const t=e.headers["Platform-Ids"];e.headers["Accept-Language"]="zh",t&&0!==t&&"0"!==t||(e.headers["Platform-Ids"]=void 0);const{user:a,token:o}=y();var r;return!c&&o&&(e.headers.Authorization=d+o),(null==a?void 0:a.shopId)&&(e.headers["Shop-Ids"]=a.shopId),e.url=(r=e.url)||r,i.addPending(e),l=!0,e}),(e=>Promise.reject(e))),u.interceptors.response.use((async e=>{var t;const a=e.data;if((null==(t=a.data)?void 0:t.total)&&(a.data.total=Number(a.data.total),a.data.size=Number(a.data.size),a.data.pages=Number(a.data.pages),a.data.current=Number(a.data.current)),200!==e.status||!a)return Promise.reject({msg:"服务器异常"});const o=a.code;return 4===o?(c||(c=!0,refreshingFn()),new Promise((t=>{h.push((a=>{e.headers.Authorization=d+a,t(u(e.config))}))}))):([200,304].includes(o)||(s.includes(o)&&console.error(e.data.msg),i.removePending(e.config)),Promise.resolve(e))}),(e=>e.response?Promise.reject(e):void 0===e.response&&l?(l=!1,Promise.reject(e)):void 0));const refreshingFn=async()=>{const e=y().refreshToken;if(e)try{c=!0,await y().login({refreshToken:e,grant_type:"refreshToken"}),h.forEach((e=>e(y().token))),h=[],c=!1}catch(e){console.log("error",e)}finally{c=!1}};var m=Object.defineProperty;const g=class _AbstractHttp{request({url:e,params:t={},data:a={},showLoading:o=!0}){return new Promise(((o,r)=>{this.doRequest(e,{data:a,params:t},a).then((e=>{(null==e?void 0:e.data)?o(e.data):r(e)})).catch((e=>{this.errHandler(e),r(e)}))}))}static notify(e){console.error(e)}errHandler(e){if(n.includes(e.code))return;if(!e.msg)return void _AbstractHttp.debounceNotify("响应错误");let t=Promise.resolve().then((()=>{_AbstractHttp.debounceNotify(e.msg)}));e.data&&e.data.forEach((e=>{e&&(t=t.then((()=>{_AbstractHttp.debounceNotify(e)})))}))}};var p,f,k;p=g,f="debounceNotify",k=o(g.notify,500),((e,t,a)=>{t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(p,f+"",k);let v=g;const w=new class extends v{doRequest(e,t,a){return u.get(e,t)}},get=e=>w.request(e),I=new class extends v{doRequest(e,t,a){return u.post(e,a,t)}},post=e=>I.request(e),doGetCaptchaSlider=()=>get({url:"saas-aimall-uaa/uaa/auth/captcha/slider"}),doPostSmsCode=e=>post({url:"saas-aimall-uaa/uaa/auth/captcha/sms",data:e}),y=e("auth",{state:()=>({user:null,token:null,refreshToken:null,loading:!1,error:null}),getters:{isAuthenticated:e=>!!e.token,currentUser:e=>e.user},actions:{init(){const e=localStorage.getItem("token"),t=localStorage.getItem("user");e&&t&&(this.token=e,this.user=JSON.parse(t))},async login(e){var a,o,r;this.loading=!0,this.error=null;try{let s;if("email"in e&&"demo@example.com"===e.email&&"password123"===e.password)s=await new Promise((t=>{t({user:{id:"demo-user",shopId:"demo-shop",email:e.email,name:"体验账号用户",role:"demo",avatar:"/assets/demo-avatar.png"},token:"demo-jwt-token"})})),this.user=s.user,this.token=s.token;else{const{data:t}=await(e=>post({showLoading:!0,url:"/saas-aimall-uaa/uaa/auth/oauth/token",data:e}))(e);console.log(t),this.user={id:null==(a=t.additionalInformation)?void 0:a.userId,shopId:null==(r=null==(o=t.additionalInformation)?void 0:o.shopId)?void 0:r[0],email:"",name:""},this.token=t.value,this.refreshToken=t.refreshToken.value}localStorage.setItem("token",this.token),localStorage.setItem("refreshToken",this.refreshToken),localStorage.setItem("user",JSON.stringify(this.user)),t("/dashboard")}catch(e){throw this.error=e.message||"Failed to login",e}finally{this.loading=!1}},async register(e){this.loading=!0,this.error=null;try{const t=await new Promise((t=>{setTimeout((()=>{t({user:{id:"1",shopId:"demo",email:e.email,name:e.name,role:"user"},token:"fake-jwt-token",refreshToken:"fake-jwt-token"})}),1e3)}));return this.user=t.user,this.token=t.token,localStorage.setItem("refreshToken",t.refreshToken),localStorage.setItem("token",t.token),localStorage.setItem("user",JSON.stringify(t.user)),t}catch(e){throw this.error=e.message||"Failed to register",e}finally{this.loading=!1}},logout(){this.user=null,this.token=null,localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user")}}});export{doPostSmsCode as a,doGetCaptchaSlider as d,get as g,post as p,y as u};
//# sourceMappingURL=auth2.mjs.map
